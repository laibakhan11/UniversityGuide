<!-- ========================================
     COMPLETE FILE: university.html (FULL VERSION)
     ======================================== -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="page-title">University - UniGuide</title>
  
  <link rel="stylesheet" href="home.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>

  <style>
    * { box-sizing: border-box; }

    .uni-hero {
      background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)), #ffffff;
      padding: 3rem 0 2rem;
      text-align: center;
    }

    .uni-name {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(135deg, #1e40af, #8b5cf6);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 0.5rem 0;
    }
    .uni-fullname {
      font-size: 1.2rem;
      color: #64748b;
      margin: 0.3rem 0;
    }
    .uni-details {
      font-size: 0.95rem;
      color: #94a3b8;
      margin-top: 0.6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      justify-content: center;
      margin: 2rem 0;
      position: sticky;
      top: 70px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(15px);
      padding: 1.2rem;
      border-radius: 50px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .filter-btn {
      background: #f1f5f9;
      color: #475569;
      border: none;
      padding: 0.75rem 1.8rem;
      border-radius: 50px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1rem;
    }
    .filter-btn.active {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      transform: scale(1.05);
    }
    .filter-btn:hover:not(.active) {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    .content-wrapper {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin: 2rem 0;
    }

    .programs-section {
      min-height: 400px;
    }

    .sidebar {
      position: sticky;
      top: 180px;
      height: fit-content;
    }

    .info-card {
      background: white;
      padding: 1.5rem;
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.06);
      border: 1px solid rgba(59,130,246,0.1);
      margin-bottom: 1.5rem;
    }
    .info-card h3 {
      font-size: 1.3rem;
      color: #1e40af;
      margin-bottom: 1rem;
      font-weight: 700;
    }

    .deadlines-list { 
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .deadline-item {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      padding: 1rem;
      border-radius: 12px;
      border-left: 4px solid #10b981;
    }
    .deadline-title { 
      font-weight: 700; 
      font-size: 0.95rem; 
      color: #065f46; 
    }
    .deadline-date { 
      font-weight: 600; 
      color: #059669; 
      font-size: 1rem; 
      margin-top: 0.3rem;
    }

    .fee-card {
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      padding: 1.5rem;
      border-radius: 18px;
      text-align: center;
      border: 2px solid #fbbf24;
    }
    .fee-main {
      font-size: 1.6rem;
      font-weight: 800;
      color: #d97706;
      margin-bottom: 0.6rem;
    }
    .fee-range {
      font-size: 0.9rem;
      color: #92400e;
      font-weight: 600;
    }

    .filter-info {
      text-align: center;
      padding: 0.8rem;
      background: linear-gradient(135deg, #dbeafe, #e0e7ff);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      font-weight: 600;
      color: #1e40af;
    }

    .department-card {
      background: white;
      border-radius: 16px;
      margin: 1.2rem 0;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
      border: 1px solid rgba(59,130,246,0.08);
      transition: all 0.3s;
    }
    .department-card:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 12px 28px rgba(0,0,0,0.1); 
    }
    .department-card.hidden {
      display: none !important;
    }

    .dept-header {
      padding: 1.3rem 1.5rem;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .dept-header h4 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 700; 
    }
    .dept-header small { 
      opacity: 0.9; 
      font-size: 0.85rem; 
      display: block;
      margin-top: 0.2rem;
    }
    .toggle-icon { 
      font-size: 1.8rem; 
      transition: transform 0.3s; 
    }
    .dept-header.open .toggle-icon {
      transform: rotate(45deg);
    }

    .programs-list {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
      background: #fafafa;
    }
    .programs-list.open {
      max-height: 80vh;
      overflow-y: auto;
      padding: 1.2rem;
    }

    .program-item {
      background: white;
      padding: 1.2rem;
      margin: 0.7rem 0;
      border-radius: 12px;
      border-left: 4px solid #3b82f6;
    }
    .program-item.hidden {
      display: none !important;
    }

    .program-name {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e40af;
      margin-bottom: 0.6rem;
    }
    .program-detail {
      margin: 0.3rem 0;
      color: #475569;
      font-size: 0.9rem;
    }
    .fee-value { 
      color: #059669; 
      font-weight: 700; 
    }
    .program-notes {
      color: #64748b;
      font-size: 0.85rem;
      font-style: italic;
      margin-top: 0.5rem;
      display: block;
    }

    .scholarships-section {
      margin: 3rem 0;
      padding: 2rem;
      background: linear-gradient(135deg, #fffbeb, #fefce8);
      border-radius: 18px;
      border: 2px solid #fbbf24;
    }
    .scholarships-section h2 {
      color: #d97706;
      font-size: 1.8rem;
      text-align: center;
      margin-bottom: 1.5rem;
      font-weight: 800;
    }
    .scholarship-item {
      background: white;
      padding: 1.2rem;
      margin: 0.8rem 0;
      border-radius: 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .scholarship-name {
      font-weight: 700;
      font-size: 1rem;
      color: #1e293b;
    }
    .scholarship-type {
      color: #d97706;
      font-size: 0.85rem;
      font-weight: 600;
      margin-top: 0.3rem;
    }
    .view-details {
      background: #f59e0b;
      color: white;
      padding: 0.5rem 1.2rem;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    @media (max-width: 1024px) {
      .content-wrapper {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: relative;
        top: 0;
      }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="container header-content">
      <div class="logo">
        <span class="logo-text">UniGuide</span>
      </div>
      <nav class="nav">
        <a href="home.html" class="nav-link">Home</a>
        <a href="deadlines.html" class="nav-link">Deadlines</a>
        <a href="aggregateCalculator.html" class="nav-link">Aggregate Calculator</a>
        <a href="chat.html" class="nav-link">AI Chat</a>
      </nav>
    </div>
  </header>

  <section class="uni-hero">
    <div class="container">
      <h1 class="uni-name" id="uni-name">Loading...</h1>
      <p class="uni-fullname" id="uni-fullname"></p>
      <div class="uni-details" id="uni-details"></div>
    </div>
  </section>

  <div class="container">
    <div class="filters">
      <button class="filter-btn active" data-filter="all">All Programs</button>
      <button class="filter-btn" data-filter="cs">CS / IT</button>
      <button class="filter-btn" data-filter="bba">Business</button>
      <button class="filter-btn" data-filter="eng">Engineering</button>
      <button class="filter-btn" data-filter="law">Law</button>
      <button class="filter-btn" data-filter="med">Medical</button>
      <button class="filter-btn" data-filter="hum">Humanities</button>
    </div>

    <div class="content-wrapper">
      <div class="programs-section" id="programs-section">
        <div id="filter-info" class="filter-info" style="display:none;"></div>
        <div id="loading" style="text-align:center; padding:2rem; color:#94a3b8;">Loading...</div>
        <div id="departments-container"></div>
      </div>

      <div class="sidebar">
        <div class="info-card">
          <h3>üìÖ Deadlines</h3>
          <div id="deadlines-container" class="deadlines-list">
            <div style="text-align:center; color:#94a3b8;">Loading...</div>
          </div>
        </div>

        <div class="info-card">
          <h3>üí∞ Fees</h3>
          <div id="fee-summary"></div>
        </div>
      </div>
    </div>

    <div id="scholarships-section" class="scholarships-section" style="display:none;"></div>
  </div>

  <footer class="footer">
    <div class="container footer-content">
      <div class="logo footer-logo">
        <span class="logo-text">UniGuide</span>
      </div>
      <div class="footer-links">
        <a href="home.html">Home</a>
        <a href="deadlines.html">Deadlines</a>
        <a href="aggregateCalculator.html">Aggregate Calculator</a>
        <a href="chat.html" class="nav-link">AI Chat</a>
      </div>
      <p class="copyright">¬© 2025 UniGuide. All rights reserved.</p>
    </div>
  </footer>

  <script src="config.js"></script>
  <script>
    const API_URL = CONFIG.API_URL;
    const uniName = new URLSearchParams(window.location.search).get('name') || 'LUMS';
    document.getElementById('uni-name').textContent = uniName;
    document.title = uniName + " - UniGuide";

    let allDeptCards = [];
    let currentFilter = 'all';

   const filterPatterns = {
  all: () => true,
cs: (t) =>
  /\bcomputer\b|\bcomputing\b|\bsoftware\b|\bcs\b|\bit\b|\bict\b|\bcyber\b|\bcybersecurity\b|\bdata\b|\bdatascience\b|\bai\b|\bartificial\b|\bintelligence\b|\bmachine\b|\bml\b|\bdeep\b|\binformation\b|\bsystems\b|\binformatics\b|\bnetwork\b|\bcloud\b|\bblockchain\b|\bprogramming\b|\bcoding\b|\bweb\b|\bmobile\b|\bapp\b|\bdev\b|\bdevelopment\b/i.test(t),

  bba: (t) =>
    /bba|business|management|finance|financial|accounting|accounts|commerce|economics|eco|marketing|hr|human\s?resource|supply|logistics|administration|admin|entrepreneur|banking|investment|audit|tax|corporate|mba/i.test(t),

  eng: (t) =>
    /engineering|engineer|electrical|electronics|mechanical|civil|chemical|automotive|aerospace|industrial|mechatronics|biomedical|petroleum|mining|metallurgy|materials|telecom|computer\s?engineering|power|energy|structural|construction/i.test(t),

  law: (t) =>
    /law|llb|llm|legal|jurisprudence|advocate|attorney|bar|corporate\s?law|criminal|civil\s?law|international\s?law|constitutional|sharia|islamic\s?law/i.test(t),

  med: (t) =>
    /medicine|medical|mbbs|bds|dpt|pharmacy|pharm|pharmd|biology|biomedical|health|healthcare|doctor|nursing|physiotherapy|radiology|pathology|anatomy|physiology|public\s?health|dentistry|veterinary|vet|clinical/i.test(t),

  hum: (t) =>
    /english|history|psychology|political|politics|sociology|social\s?science|media|mass\s?communication|journalism|art|fine\s?arts|design|literature|islamic|islamiyat|urdu|arabic|philosophy|anthropology|education|linguistics|geography|civics|cultural/i.test(t)
};

    function applyFilter() {
      let totalVisible = 0;
      let visibleDepts = 0;

      allDeptCards.forEach(({ card, programs }) => {
        let visibleInDept = 0;

        programs.forEach(({ element, name, dept }) => {
          const text = `${name} ${dept}`.toLowerCase();
          if (filterPatterns[currentFilter](text)) {
            element.classList.remove('hidden');
            visibleInDept++;
            totalVisible++;
          } else {
            element.classList.add('hidden');
          }
        });

        if (visibleInDept > 0) {
          card.classList.remove('hidden');
          const countEl = card.querySelector('.dept-count');
          if (countEl) countEl.textContent = `${visibleInDept} program${visibleInDept > 1 ? 's' : ''}`;
          visibleDepts++;
          
          // Auto-expand if filtering
          if (currentFilter !== 'all') {
            const list = card.querySelector('.programs-list');
            const header = card.querySelector('.dept-header');
            list.classList.add('open');
            header.classList.add('open');
          }
        } else {
          card.classList.add('hidden');
        }
      });

      const infoEl = document.getElementById('filter-info');
      if (currentFilter !== 'all') {
        infoEl.style.display = 'block';
        const filterName = document.querySelector(`.filter-btn[data-filter="${currentFilter}"]`).textContent;
        infoEl.textContent = `Showing ${totalVisible} ${filterName} programs in ${visibleDepts} departments`;
      } else {
        infoEl.style.display = 'none';
      }
    }

   document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    currentFilter = btn.dataset.filter;
    applyFilter();

    // ‚úÖ Scroll to first visible department
    setTimeout(() => {
      const firstVisibleDept = document.querySelector(
        '.department-card:not(.hidden) .dept-header'
      );

      if (firstVisibleDept) {
        const yOffset = -140; // adjust for sticky filter bar
        const y =
          firstVisibleDept.getBoundingClientRect().top +
          window.pageYOffset +
          yOffset;

        window.scrollTo({
          top: y,
          behavior: 'smooth'
        });
      }
    }, 100); // small delay so DOM updates first
  });
});

    async function loadUniversity() {
      try {
        console.log('Fetching:', `${API_URL}/api/university/${encodeURIComponent(uniName)}`);
        const res = await fetch(`${API_URL}/api/university/${encodeURIComponent(uniName)}`);
        const uni = await res.json();
        
        if (uni.error) {
          throw new Error(uni.error);
        }

        console.log('University loaded:', uni);

        document.getElementById('uni-fullname').textContent = uni.full_name || uni.fullName || uni.name;
        
        const details = [];
        if (uni.city) details.push(`üìç ${uni.city}`);
        if (uni.address) details.push(`üè¢ ${uni.address}`);
        if (uni.email) details.push(`üìß ${uni.email}`);
        document.getElementById('uni-details').innerHTML = details.join(' ‚Ä¢ ');

        document.getElementById('loading').style.display = 'none';

        // Deadlines
        const deadlinesEl = document.getElementById('deadlines-container');
        if (uni.deadlines && uni.deadlines.length > 0) {
          deadlinesEl.innerHTML = uni.deadlines.map(d => `
            <div class="deadline-item">
              <div class="deadline-title">${d.title}</div>
              <div class="deadline-date">üìÖ ${d.deadline_date}</div>
            </div>
          `).join('');
        } else {
          deadlinesEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:1rem;">No deadlines</div>';
        }

        // Fees
        const fees = (uni.programs || []).map(p => p.total_fee_first_year).filter(f => f && f > 0);
        const feeEl = document.getElementById('fee-summary');
        if (fees.length > 0) {
          const avg = Math.round(fees.reduce((a,b) => a+b, 0) / fees.length);
          const min = Math.min(...fees);
          const max = Math.max(...fees);
          feeEl.innerHTML = `
            <div class="fee-card">
              <div class="fee-main">PKR ${avg.toLocaleString()}</div>
              <div style="font-weight:600; color:#92400e; margin:0.5rem 0;">Average First Year</div>
              <div class="fee-range">${min.toLocaleString()} - ${max.toLocaleString()}</div>
            </div>
          `;
        } else {
          feeEl.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:1rem;">No fee data</div>';
        }

        // Programs
        const deptMap = {};
        (uni.programs || []).forEach(p => {
          const dept = (p.department || '').trim() || 'Other';
          if (!deptMap[dept]) deptMap[dept] = [];
          deptMap[dept].push(p);
        });

        const container = document.getElementById('departments-container');
        container.innerHTML = '';
        allDeptCards = [];

        if (Object.keys(deptMap).length === 0) {
          container.innerHTML = '<div style="text-align:center; padding:3rem; color:#94a3b8;">No programs found</div>';
        } else {
          Object.keys(deptMap).sort().forEach(deptName => {
            const progs = deptMap[deptName];
            const card = document.createElement('div');
            card.className = 'department-card';

            const progsHTML = progs.map(p => {
              const e = p.eligibility || {};
              return `
                <div class="program-item">
                  <div class="program-name">${p.name || 'Unnamed'}</div>
                  <div class="program-detail">üí∞ First Year: <span class="fee-value">PKR ${(p.total_fee_first_year || 0).toLocaleString()}</span></div>
                  ${p.fee_per_semester ? `<div class="program-detail">üìù Per Semester: PKR ${p.fee_per_semester.toLocaleString()}</div>` : ''}
                  <div class="program-detail">üìã Eligibility: Matric ‚â• ${e.min_percentage_matric || 'N/A'}%, Inter ‚â• ${e.min_percentage_inter || 'N/A'}%</div>
                  <div class="program-detail">üìù Test: ${e.entry_test || 'None'}</div>
                  ${e.notes ? `<div class="program-notes">‚ÑπÔ∏è ${e.notes}</div>` : ''}
                  ${p.notes ? `<div class="program-notes">üí° ${p.notes}</div>` : ''}
                </div>
              `;
            }).join('');

            card.innerHTML = `
              <div class="dept-header">
                <div>
                  <h4>${deptName}</h4>
                  <small class="dept-count">${progs.length} program${progs.length > 1 ? 's' : ''}</small>
                </div>
                <span class="toggle-icon">+</span>
              </div>
              <div class="programs-list">${progsHTML}</div>
            `;

            const header = card.querySelector('.dept-header');
            const list = card.querySelector('.programs-list');
            header.onclick = () => {
              list.classList.toggle('open');
              header.classList.toggle('open');
            };

            const progElements = [];
            card.querySelectorAll('.program-item').forEach((el, idx) => {
              progElements.push({ element: el, name: progs[idx].name || '', dept: deptName });
            });

            allDeptCards.push({ card, programs: progElements });
            container.appendChild(card);
          });
        }

        // Scholarships
        if (uni.scholarships && uni.scholarships.length > 0) {
          const section = document.getElementById('scholarships-section');
          section.style.display = 'block';
          section.innerHTML = `
            <h2>üéì Available Scholarships</h2>
            ${uni.scholarships.map(s => `
              <div class="scholarship-item">
                <div>
                  <div class="scholarship-name">${s.name || 'Scholarship'}</div>
                  <div class="scholarship-type">Type: ${s.type || 'Merit/Need Based'}</div>
                  ${s.notes ? `<div style="color:#64748b; font-size:0.85rem; margin-top:0.3rem;">${s.notes}</div>` : ''}
                </div>
                ${s.link ? `<a href="${s.link}" target="_blank" class="view-details">View Details</a>` : ''}
              </div>
            `).join('')}
          `;
        }

      } catch (err) {
        console.error('Error loading university:', err);
        document.getElementById('loading').innerHTML = 
          `<div style="text-align:center; padding:3rem; color:#ef4444;">
            ‚ùå Error: ${err.message}<br>
            <small style="color:#94a3b8; margin-top:0.5rem; display:block;">Check console for details</small>
          </div>`;
      }
    }

    loadUniversity();
  </script>
 <script src="chatWidget.js"></script>
</body>
</html>