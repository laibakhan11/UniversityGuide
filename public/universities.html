<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="page-title">University - UniGuide</title>
  <link rel="stylesheet" href="home.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  
  <style>
    body { font-family: 'Inter', sans-serif; background: #f8fffe; color: #1a1a1a; margin: 0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 1rem; }

    .search-bar {
      margin: 2rem auto; max-width: 600px; display: flex;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 50px; overflow: hidden;
    }
    .search-bar input { flex: 1; padding: 1rem 1.5rem; border: none; font-size: 1.1rem; outline: none; }
    .search-bar button { background: #37b9ac; color: white; border: none; padding: 0 2rem; cursor: pointer; font-weight: bold; }

    .filters { text-align: center; margin: 2rem 0; display: flex; flex-wrap: wrap; gap: 0.8rem; justify-content: center; }
    .filter-btn { background: #f0f0f0; color: #333; border: none; padding: 0.7rem 1.4rem; border-radius: 50px; cursor: pointer; font-weight: 600; transition: 0.3s; }
    .filter-btn:hover, .filter-btn.active { background: #37b9ac; color: white; }

    .info-section {
      background: white; border-radius: 16px; padding: 2rem; margin: 2rem 0;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }
    .info-section h2 {
      color: #37b9ac; text-align: center; margin-bottom: 1.5rem; font-size: 2rem;
    }

    .deadlines-list {
      display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    .deadline-item {
      background: #e6f7f5; padding: 1.2rem; border-radius: 12px; border-left: 5px solid #37b9ac;
    }
    .deadline-title { font-weight: 700; font-size: 1.1rem; }
    .deadline-date { font-weight: bold; color: #37b9ac; margin-top: 0.5rem; font-size: 1.05rem; }

    .fee-summary {
      background: linear-gradient(135deg, #fff8e1, #fff0b3); padding: 2rem; border-radius: 16px;
      text-align: center; font-size: 1.3rem; font-weight: 600; color: #d97706;
    }

    .department-card { background: white; border-radius: 16px; padding: 1.8rem; margin: 1.5rem 0; box-shadow: 0 6px 20px rgba(0,0,0,0.08); transition: 0.3s; }
    .department-card:hover { transform: translateY(-6px); }
    .dept-header { display: flex; justify-content: space-between; align-items: center; font-size: 1.5rem; font-weight: 700; cursor: pointer; }
    .toggle-icon { font-size: 2rem; color: #37b9ac; user-select: none; }

    .programs-list { margin-top: 1.5rem; display: none; }
    .programs-list.open { display: block; }

    .program-item { background: #f8fffe; padding: 1.2rem; margin: 1rem 0; border-radius: 12px; border-left: 5px solid #37b9ac; }
    .program-item.hidden { display: none !important; }
    .program-name { font-weight: 700; font-size: 1.15rem; margin-bottom: 0.5rem; }
    .fee { color: #37b9ac; font-weight: bold; font-size: 1.1rem; }

    .scholarships-section { margin: 4rem 0; padding: 2rem; background: linear-gradient(135deg, #fff8e1, #fff0b3); border-radius: 16px; text-align: center; }
    .scholarship-item { background: white; padding: 1.2rem; margin: 1rem 0; border-radius: 12px; border-left: 5px solid #ffb300; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .view-details { color: #37b9ac; font-weight: bold; text-decoration: none; }
    .view-details:hover { text-decoration: underline; }

    .loading { text-align: center; padding: 4rem; font-size: 1.4rem; color: #666; }
  </style>
</head>
<body>

  <header class="header">
    <div class="container header-content">
      <div class="logo">
        <span class="logo-icon">Book</span>
        <span class="logo-text">UniGuide</span>
      </div>
      <nav class="nav">
        <a href="home.html" class="nav-link">Home</a>
        <a href="universities.html" class="nav-link">Universities</a>
      </nav>
    </div>
  </header>

  <section class="hero" style="text-align:center; padding: 3rem 0;">
    <div class="container">
      <h1 id="uni-name" style="font-size: 3rem; margin:0; color:#37b9ac;">Loading...</h1>
      <p id="uni-fullname" style="font-size:1.3rem; color:#555;"></p>
    </div>
  </section>

  <div class="container">

    <div class="search-bar">
      <input type="text" id="program-search" placeholder="Search programs (e.g. Computer Science, BBA, Law...)" />
      <button>Search</button>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-filter="all">All Programs</button>
      <button class="filter-btn" data-filter="cs">CS / IT</button>
      <button class="filter-btn" data-filter="bba">BBA / Business</button>
      <button class="filter-btn" data-filter="eng">Engineering</button>
      <button class="filter-btn" data-filter="law">Law</button>
      <button class="filter-btn" data-filter="med">Medical</button>
      <button class="filter-btn" data-filter="hum">Humanities</button>
    </div>

    <!-- Deadlines -->
    <div class="info-section">
      <h2>Admission Deadlines</h2>
      <div id="deadlines-container" class="deadlines-list">
        <div class="loading">Loading deadlines...</div>
      </div>
    </div>

    <!-- Fee Summary -->
    <div class="info-section">
      <h2>Fee Structure Overview</h2>
      <div id="fee-summary" class="fee-summary">Calculating...</div>
    </div>

    <h2 style="text-align:center; margin: 2rem 0; font-size:2rem; color:#37b9ac;">Departments & Programs</h2>
    <div id="loading" class="loading">Loading programs...</div>
    <div id="departments-container"></div>

    <div id="scholarships-section" class="scholarships-section"></div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const uniName = urlParams.get('name') || 'LUMS';
    document.getElementById('uni-name').textContent = uniName;
    document.title = uniName + " - UniGuide";

    let allProgramItems = [];

    function filterPrograms() {
      const search = document.getElementById('program-search').value.toLowerCase();
      const filter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';

      allProgramItems.forEach(item => {
        const name = item.querySelector('.program-name').textContent.toLowerCase();
        let show = name.includes(search);

        if (filter !== 'all') {
          const filters = {
            cs: /computer|cs|software|ai|data science|it/,
            bba: /bba|business|accounting|finance|management/,
            eng: /engineering/,
            law: /law|llb/,
            med: /pharmacy|therapy|biology|health|medical|doctor/,
            hum: /english|history|psychology|political|sociology|art|literature/
          };
          show = show && filters[filter].test(name);
        }

        item.classList.toggle('hidden', !show);
      });
    }

    document.getElementById('program-search').addEventListener('input', filterPrograms);
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        filterPrograms();
      });
    });

    async function loadUniversity() {
      try {
        const res = await fetch(`/api/university/${uniName}`);
        const university = await res.json();
        if (university.error) throw new Error(university.error);

        document.getElementById('uni-fullname').textContent = university.full_name || university.name;
        document.getElementById('loading').style.display = 'none';

        // Deadlines
        const deadlinesContainer = document.getElementById('deadlines-container');
        if (university.deadlines?.length > 0) {
          deadlinesContainer.innerHTML = university.deadlines.map(d => `
            <div class="deadline-item">
              <div class="deadline-title">${d.title || 'Deadline'}</div>
              <div class="deadline-date">${d.deadline_date || 'Not specified'}</div>
            </div>
          `).join('');
        } else {
          deadlinesContainer.innerHTML = '<p style="text-align:center; color:#999;">No deadlines available</p>';
        }

        // Fee Summary
        const fees = university.programs?.map(p => p.total_fee_first_year).filter(f => f > 0) || [];
        if (fees.length > 0) {
          const avg = Math.round(fees.reduce((a,b) => a+b, 0) / fees.length);
          const min = Math.min(...fees);
          const max = Math.max(...fees);
          document.getElementById('fee-summary').innerHTML = `
            <strong>Average First Year Fee:</strong> PKR ${avg.toLocaleString()}<br><br>
            <small>Range: PKR ${min.toLocaleString()} – PKR ${max.toLocaleString()}</small>
          `;
        } else {
          document.getElementById('fee-summary').innerHTML = 'Fee information not available';
        }

        // Programs & Departments
        const deptMap = {};
        (university.programs || []).forEach(p => {
          const dept = p.department || "General";
          if (!deptMap[dept]) deptMap[dept] = [];
          deptMap[dept].push(p);
        });

        const container = document.getElementById('departments-container');
        allProgramItems = [];

        Object.keys(deptMap).sort().forEach(deptName => {
          const deptDiv = document.createElement('div');
          deptDiv.className = 'department-card';

          const programsHTML = deptMap[deptName].map(prog => `
            <div class="program-item">
              <div class="program-name">${prog.name}</div>
              <div><strong>Fee (1st Year):</strong> <span class="fee">PKR ${prog.total_fee_first_year?.toLocaleString() || 'N/A'}</span></div>
              <div><strong>Eligibility:</strong> Matric ≥ ${prog.eligibility?.min_percentage_matric || 'N/A'}%, Inter ≥ ${prog.eligibility?.min_percentage_inter || 'N/A'}%</div>
              <div><strong>Entry Test:</strong> ${prog.eligibility?.entry_test || 'N/A'}</div>
              <div><em>${prog.eligibility?.notes || ''}</em></div>
            </div>
          `).join('');

          deptDiv.innerHTML = `
            <div class="dept-header">
              <span>${deptName}</span>
              <span class="toggle-icon">+</span>
            </div>
            <div class="programs-list">${programsHTML}</div>
          `;

          deptDiv.querySelector('.dept-header').onclick = () => {
            const list = deptDiv.querySelector('.programs-list');
            const icon = deptDiv.querySelector('.toggle-icon');
            list.classList.toggle('open');
            icon.textContent = list.classList.contains('open') ? '−' : '+';
          };

          container.appendChild(deptDiv);
          deptDiv.querySelectorAll('.program-item').forEach(item => allProgramItems.push(item));
        });

        // Scholarships
        if (university.scholarships?.length > 0) {
          const sec = document.getElementById('scholarships-section');
          sec.innerHTML = `<h2 style="color:#ffb300;">Available Scholarships</h2>`;
          const list = document.createElement('div');
          university.scholarships.forEach(s => {
            list.innerHTML += `
              <div class="scholarship-item">
                <div><strong>${s.name}</strong><br><small>Type: ${s.type || 'Merit/Need'}</small></div>
                ${s.link ? `<a href="${s.link}" target="_blank" class="view-details">View Details</a>` : ''}
              </div>
            `;
          });
          sec.appendChild(list);
        }

      } catch (err) {
        document.getElementById('loading').innerHTML = `<p style="color:red;">Error: ${err.message}</p>`;
      }
    }

    loadUniversity();
  </script>
</body>
</html>